<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Flashcard Generator (with Login + Google Sheet logging)</title>
<style>
  :root{
    --bg:#0f172a; --paper:#0b1224; --ink:#ffffff; --accent:#60a5fa; --muted:#9aa6bd; --card:#111827;
    --shadow:0 6px 18px rgba(0,0,0,.25); --radius:16px;
    --font: system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, sans-serif;
    --xl: clamp(28px, 5.2vw, 64px); --lg: clamp(18px, 2.6vw, 30px); --md: clamp(14px, 2vw, 20px);
  }
  body.sleek { --bg:#0f172a; --paper:#111827; --ink:#ffffff; --card:#0b1224; --accent:#60a5fa; }
  body.playful { --bg:#f9e000; --paper:#fff7b2; --ink:#111111; --card:#ffffff; --accent:#ff6b6b; }
  body.exam { --bg:#000000; --paper:#000000; --ink:#ffffff; --card:#000000; --accent:#ffffff; }

  html,body{height:100%} body{ margin:0; background:var(--bg); color:var(--ink); font-family:var(--font);}
  .wrap{ max-width:min(1200px, 92vw); margin: 24px auto 80px; }
  header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:18px; }
  .title{ font-weight:700; letter-spacing:.3px; font-size:var(--lg); }
  .row{display:flex; flex-wrap:wrap; gap:12px; align-items:center}
  select, input[type="text"], textarea, button{ font:inherit; border-radius:12px; border:1px solid transparent; padding:12px 14px; background:var(--card); color:var(--ink); }
  textarea{ width:100%; min-height:220px; line-height:1.4; resize:vertical; box-shadow:var(--shadow);}
  button{ cursor:pointer; background:var(--accent); color:#000; font-weight:700; border:none; }
  button.ghost{ background:transparent; border:1px solid var(--muted); color:var(--ink); }
  .pill{ padding:8px 12px; border:1px solid var(--muted); background:transparent; color:var(--ink); border-radius:999px }
  .panel{ background:var(--paper); border-radius:var(--radius); padding:18px; box-shadow:var(--shadow); margin-top:12px; }
  .tabs{ display:flex; gap:6px; margin-top:8px; }
  .tab{ padding:10px 14px; border-radius:999px; border:1px solid var(--muted); cursor:pointer; background:transparent; color:var(--ink); }
  .tab.active{ background:var(--accent); color:#000; border-color:transparent; font-weight:800 }
  .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:18px; }
  @media (max-width:900px){ .grid{ grid-template-columns: 1fr; } }
  .hint{ color:var(--muted); font-size:var(--md); }
  .flashcard{ user-select:none; background:var(--card); border-radius:20px; padding: clamp(24px, 6vw, 48px); text-align:center; box-shadow:var(--shadow);
              min-height: min(50vh, 520px); display:flex; flex-direction:column; align-items:center; justify-content:center;}
  .fc-text{ font-size:var(--xl); font-weight:800; line-height:1.15; word-break:break-word; }
  .fc-sub{ margin-top:10px; font-size:var(--md); color:var(--muted) }
  .controls{ display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin-top:16px; }
  .small{ font-size:var(--md) }
  .badge{ font-weight:700; font-size:var(--md); color:var(--muted) }
  .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  .footer-note{ margin-top:18px; color:var(--muted); font-size:var(--md) }
  a.link { color: var(--accent); font-weight:700; text-decoration:none; border-bottom:1px dashed var(--accent) }

  /* Name gate modal */
  .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; }
  .modal{ width:min(560px, 92vw); background:var(--paper); border-radius:16px; padding:20px; box-shadow:var(--shadow); }
  .modal h2{ margin:0 0 8px 0 }
</style>
</head>
<body class="sleek">
  <div class="wrap">
    <header>
      <div class="title">Flashcard Generator</div>
      <div class="row">
        <label class="pill">
          Theme:
          <select id="themeSel" class="pill" aria-label="Theme">
            <option value="sleek">Sleek</option>
            <option value="playful">Playful</option>
            <option value="exam">Exam</option>
          </select>
        </label>
        <button class="ghost" id="helpBtn">Help</button>
      </div>
    </header>

    <div class="tabs">
      <button class="tab active" id="tabBuild">Build set</button>
      <button class="tab" id="tabPlay">Flashcards</button>
    </div>

    <section id="build" class="panel">
      <div class="grid">
        <div>
          <label class="hint">Set title</label>
          <input id="setTitle" type="text" placeholder="e.g. Y8 Holidays — Core chunks" />
          <div style="height:8px"></div>
          <label class="hint">Paste pairs (one per line). Use <span class="mono">tab</span>, <span class="mono">,</span>, <span class="mono">;</span> or <span class="mono">:</span> as separator.</label>
          <textarea id="pairsInput" placeholder="groß; big
die Stadt, the city
freundlich : friendly
ich spiele\tI play"></textarea>

          <div class="row" style="margin-top:10px">
            <button id="btnMake">Generate shareable link</button>
            <button class="ghost" id="btnPreview">Preview in Flashcards</button>
            <span class="badge" id="countBadge">0 pairs</span>
          </div>
        </div>

        <div>
          <label class="hint">Your link</label>
          <input id="shareLink" type="text" readonly placeholder="Will appear here…" />
          <div class="row" style="margin-top:10px">
            <button id="btnCopy" class="ghost">Copy link</button>
            <button id="btnOpen" class="ghost">Open link</button>
          </div>
          <div class="footer-note">
            Anyone opening your link will see the flashcards for **this set**.
            Nothing is stored on a server; the set is encoded in the URL hash.
            <br>Tip: add a class code in the URL like <span class="mono">?class=Y8A</span> to tag logs.
          </div>
        </div>
      </div>
    </section>

    <section id="play" class="panel" style="display:none">
      <div class="row" style="justify-content:space-between; gap:10px">
        <div>
          <div class="badge" id="setName">Untitled set</div>
          <div class="hint" id="progress">0 / 0</div>
        </div>
        <div class="row">
          <button class="ghost small" id="btnSwap">Swap sides</button>
          <button class="ghost small" id="btnShuffle">Shuffle</button>
          <button class="ghost small" id="btnRestart">Restart</button>
        </div>
      </div>

      <div style="height:14px"></div>

      <div class="flashcard" id="card">
        <div class="fc-text" id="cardFront">No set loaded</div>
        <div class="fc-text" id="cardBack" style="display:none; margin-top:10px; opacity:.85"></div>
        <div class="fc-sub" id="fcHint">Paste a set and click “Generate shareable link”, or open a link with <span class="mono">#set=…</span></div>
      </div>

      <div class="controls">
        <button id="btnPrev">◀︎ Prev</button>
        <button id="btnReveal">Reveal Answer</button>
        <button id="btnNext">Next ▶︎</button>
      </div>
    </section>
  </div>

  <!-- Name gate modal -->
  <div class="modal-backdrop" id="modalBg">
    <div class="modal">
      <h2>Enter your name</h2>
      <p class="hint">Your teacher will see that you’ve used these flashcards.</p>
      <div class="row">
        <input id="nameInput" type="text" placeholder="First name + initial (e.g. Alex B.)" style="flex:1" />
      </div>
      <div class="row" style="margin-top:10px">
        <button id="nameConfirm">Start</button>
        <button class="ghost" id="nameCancel">Cancel</button>
      </div>
      <div class="hint" style="margin-top:8px">Tip: add <span class="mono">?class=Y8A</span> to the link to tag your class.</div>
    </div>
  </div>

<script>
/* ====================== CONFIG – PASTE YOUR WEB APP URL HERE ====================== */
https://script.google.com/macros/s/AKfycbx06vsfbahkiyd_60IaGvHbdXO1bkpHT2lXL7v7rydJbF0I15zsQWk81w0IYt4m_jBJ/exec
/* ================================================================================== */

/* ---------- Utilities ---------- */
const toBase64 = (obj) => btoa(unescape(encodeURIComponent(JSON.stringify(obj))));
const fromBase64 = (b64) => { try { return JSON.parse(decodeURIComponent(escape(atob(b64)))); } catch(e){ return null; } };
const $ = (id)=>document.getElementById(id);
const getQuery = (key)=> new URLSearchParams(location.search).get(key)||'';
const CLASS_CODE = getQuery('class') || '';

/* ---------- State ---------- */
let PAIRS = [];
let SHOW_FRONT = true;
let IDX = 0;
let TITLE = '';
let USER_NAME = localStorage.getItem('fc_userName') || '';

/* ---------- Elements ---------- */
const pairsInput = $('pairsInput');
const setTitle   = $('setTitle');
const countBadge = $('countBadge');
const shareLink  = $('shareLink');
const setName    = $('setName');
const progress   = $('progress');
const cardFront  = $('cardFront');
const cardBack   = $('cardBack');
const fcHint     = $('fcHint');
const themeSel   = $('themeSel');
const modalBg    = $('modalBg');
const nameInput  = $('nameInput');

/* ---------- Theme ---------- */
(function initTheme(){
  const t = localStorage.getItem('fc_theme') || 'sleek';
  themeSel.value = t; document.body.className = t;
})();
themeSel.addEventListener('change', ()=>{ document.body.className = themeSel.value; localStorage.setItem('fc_theme', themeSel.value); });

/* ---------- Tabs ---------- */
const tabBuild = $('tabBuild'), tabPlay = $('tabPlay');
const build = $('build'), play = $('play');
function activate(tab){
  if(tab==='build'){ tabBuild.classList.add('active'); tabPlay.classList.remove('active'); build.style.display='block'; play.style.display='none'; }
  else { tabPlay.classList.add('active'); tabBuild.classList.remove('active'); play.style.display='block'; build.style.display='none'; }
}
tabBuild.onclick = ()=>activate('build');
tabPlay.onclick = ()=>activate('play');

/* ---------- Parsing ---------- */
function parsePairs(text){
  const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  const pairs = [];
  for(const line of lines){
    const m = line.split(/\t|;|:|,/);
    if(m.length >= 2){
      const left = m[0].trim();
      const right = m.slice(1).join(',').trim();
      if(left && right) pairs.push({front:left, back:right});
    }
  }
  return pairs;
}
function updateCount(){
  const pairs = parsePairs(pairsInput.value);
  countBadge.textContent = `${pairs.length} pair${pairs.length===1?'':'s'}`;
}
pairsInput.addEventListener('input', updateCount); updateCount();

/* ---------- Build: create link ---------- */
$('btnMake').onclick = ()=>{
  const pairs = parsePairs(pairsInput.value);
  if(pairs.length===0){ alert('Please add at least one pair.'); return; }
  const title = (setTitle.value||'Untitled set').trim();
  const payload = { title, pairs };
  const b64 = toBase64(payload);
  // Preserve class code in link if present
  const base = `${location.origin}${location.pathname}`;
  const query = CLASS_CODE ? `?class=${encodeURIComponent(CLASS_CODE)}` : location.search;
  const url = `${base}${query}#set=${b64}`;
  shareLink.value = url;
  loadFromPayload(payload);
  activate('play');
};
$('btnPreview').onclick = ()=>{
  const pairs = parsePairs(pairsInput.value);
  if(pairs.length===0){ alert('Please add at least one pair.'); return; }
  loadFromPayload({ title: (setTitle.value||'Untitled set').trim(), pairs });
  activate('play');
};
$('btnCopy').onclick = async ()=>{
  if(!shareLink.value){ alert('Make a link first.'); return; }
  try{ await navigator.clipboard.writeText(shareLink.value); $('btnCopy').textContent='Copied!'; setTimeout(()=>$('btnCopy').textContent='Copy link',1100); }
  catch(e){ alert('Copy failed—select and copy manually.'); }
};
$('btnOpen').onclick = ()=>{ if(shareLink.value) window.open(shareLink.value, '_blank'); };

/* ---------- Logger ---------- */
async function logEvent(event, extra={}){
  if(!GAS_URL || GAS_URL.startsWith('PASTE_')) return; // safety: no-op if not configured
  // Assemble payload
  const pair = (PAIRS[IDX] || {front:'', back:''});
  const body = {
    classCode: CLASS_CODE,
    userName: USER_NAME,
    setTitle: TITLE,
    event,
    cardIndex: PAIRS.length ? (IDX+1) : '',
    cardFront: pair.front,
    cardBack: pair.back,
    userAgent: navigator.userAgent,
    ...extra
  };
  try{
    await fetch(GAS_URL + `?origin=${encodeURIComponent(location.origin)}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body),
      mode: 'no-cors' // Apps Script returns opaque to the browser; that’s fine
    });
  }catch(e){
    // Silent fail is fine for class use
  }
}

/* ---------- Name gate ---------- */
function askForName(thenStart){
  nameInput.value = '';
  modalBg.style.display = 'flex';
  setTimeout(()=> nameInput.focus(), 50);
  $('nameConfirm').onclick = ()=>{
    const v = nameInput.value.trim();
    if(!v){ alert('Please enter your name'); return; }
    USER_NAME = v;
    localStorage.setItem('fc_userName', USER_NAME);
    modalBg.style.display = 'none';
    logEvent('start');
    thenStart && thenStart();
  };
  $('nameCancel').onclick = ()=>{ modalBg.style.display = 'none'; };
}

/* ---------- Flashcards UI ---------- */
function loadFromPayload(payload){
  TITLE = payload.title || 'Untitled set';
  PAIRS = (payload.pairs || []).map(p=>({front:String(p.front||''), back:String(p.back||'')})).filter(p=>p.front && p.back);
  IDX = 0; SHOW_FRONT = true;
  renderCard();
  // If playing a shared set and no username yet, ask now
  if(!USER_NAME){
    askForName(()=>{ /* started via modal */ });
  } else {
    logEvent('start'); // starting or reloading set
  }
}
function renderCard(){
  setName.textContent = TITLE;
  progress.textContent = PAIRS.length ? `${IDX+1} / ${PAIRS.length}` : '0 / 0';
  if(!PAIRS.length){
    cardFront.textContent = 'No set loaded';
    cardBack.style.display='none';
    fcHint.style.display='block';
    return;
  }
  fcHint.style.display='none';
  const pair = PAIRS[IDX];
  cardFront.textContent = SHOW_FRONT ? pair.front : pair.back;
  cardBack.textContent  = SHOW_FRONT ? pair.back  : pair.front;
  cardBack.style.display='none';
}

$('btnReveal').onclick = ()=>{
  if(!PAIRS.length) return;
  const nowVisible = (cardBack.style.display==='none');
  cardBack.style.display = nowVisible ? 'block' : 'none';
  logEvent('reveal', { visible: nowVisible });
};
$('btnNext').onclick = ()=>{
  if(!PAIRS.length) return;
  IDX = (IDX+1) % PAIRS.length;
  cardBack.style.display='none';
  renderCard();
  logEvent('next');
};
$('btnPrev').onclick = ()=>{
  if(!PAIRS.length) return;
  IDX = (IDX-1+PAIRS.length) % PAIRS.length;
  cardBack.style.display='none';
  renderCard();
  logEvent('next', { direction:'prev' });
};
$('btnShuffle').onclick = ()=>{
  if(!PAIRS.length) return;
  for(let i=PAIRS.length-1; i>0; i--){
    const j = Math.floor(Math.random()*(i+1));
    [PAIRS[i], PAIRS[j]] = [PAIRS[j], PAIRS[i]];
  }
  IDX = 0; cardBack.style.display='none'; renderCard();
  logEvent('shuffle');
};
$('btnSwap').onclick = ()=>{
  SHOW_FRONT = !SHOW_FRONT;
  cardBack.style.display='none';
  renderCard();
  logEvent('swap', { showFront: SHOW_FRONT });
};
$('btnRestart').onclick = ()=>{
  IDX = 0; cardBack.style.display='none'; renderCard();
  logEvent('restart');
};

/* ---------- Hash loading ---------- */
function loadFromHash(){
  const hash = location.hash || '';
  const m = hash.match(/#set=([^&]+)/);
  if(!m) return;
  const payload = fromBase64(m[1]);
  if(payload && payload.pairs && payload.pairs.length){
    loadFromPayload(payload);
    activate('play');
  }
}
window.addEventListener('hashchange', loadFromHash);
loadFromHash();

/* ---------- Help ---------- */
$('helpBtn').onclick = ()=>{
  alert(
`Vocab input:
- One pair per line
- Separator: tab, ;, : or ,
- Example:
   groß; big
   die Stadt, the city
   freundlich : friendly
   ich spiele\tI play

Logging:
- On first play, users enter a name.
- Add ?class=Y8A to your link to tag class in the log.
- Events logged: start, next, reveal, swap, shuffle, restart.

Privacy:
- Names and actions are stored in your Google Sheet.`
  );
};

/* ---------- Auto-name prompt when teacher clicks "Flashcards" manually ---------- */
tabPlay.addEventListener('click', ()=>{
  if(!USER_NAME){
    askForName(()=>{ /* when confirmed, user can continue */ });
  }
});
</script>
</body>
</html>
